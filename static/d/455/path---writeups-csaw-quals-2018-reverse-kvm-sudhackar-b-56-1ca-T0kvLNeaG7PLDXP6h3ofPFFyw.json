{"pageContext":{"html":"<p><a href=\"ctf=csaw-finals-2018\"></a>\n<a href=\"type=reverse\"></a>\n<a href=\"tags=tree\"></a>\n<a href=\"tools=ida,%20r2\"></a></p>\n<h1>kvm (rev-500)</h1>\n<pre><code>Reversing\nkvm\n\nWe found a mysterious program that none of our most talented hackers could even begin to figure out.\n\nAuthor: toshi\n\nSolves: 58\n</code></pre>\n<p>We are given a <a href=\"/chall-500-kvm-b7348cee78b569878f54837e6763d227.elf\">file</a></p>\n<p>This sets up a vm and a vcpu using KVM apis. An area is mmaped between both machines loaded at 0x0 in guest. Then <code>_payload</code> from the binary is copied to this area and <code>rip</code> is set to 0. This means code for vm begins at <code>0x202174</code> and probably ends at <code>0x20348C</code></p>\n<p>Code at <code>0x202174</code> is quite straight forward:</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/38292aa225959be8f28e962a57e63411/88a47/start_vm.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 720px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 104.70430107526883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAADKklEQVQ4y22U2Y7cNhBF9f+fFeTBDgx44snYvbd2ihT3RRLFpcLudoA4iHQeLqm6RYJVVBVionwxLkqZnEuxvCkDgHPOWFtEyrmM/5fKh4gVJkIyurptX6N/xD7N2tgiY8qppHgS8y9Uyx7rdhpH2vcYU4YZnymVSiE0Cf0w7ylt8Sd7hn9T+QxLjMsePo7N4Y6oMZwJYd0SYgCoh/nHeRDSCmW5VEzpMulTLq5CtSXYHmnyMIlxlJybbu7Fc8Mlrp3YpRnO9/52bq+nth9xmVxjfrgSVK4ogI6IUz00PbnUGBGCOb80hGpLraBaYS3dstplW926hLQkeFHZp/nekbqm1pbPzkffDP2nz381zUxmyjhtR7SWIyxs3oXkEryobACXYcR6cQFPm6Y8QWBK1iPBwt0RHzgnuhQRbGHxdk82wotKhWwfB8Mw4Zcrq8e5n+g0i9ktJoPwj9RF6Ag6gV683tNDP6nUc3Ze/KRdS8XvX05v38f3AxmoabEhS1Axy5BLmEqgFq/29NBPKhFA7FlGMAB09feaKOn9FspDBUPaldQi5EdYBOG88Omhn1Q8gMzAI7AAo/V1P7cjvV3bcUDH+4DMWs6gxDyIwJ3nPv0cFjMN+dsNXUaOtWoYviN0GbpT233+8uN4rOdhIEoPTJItlCzMeeZTWeZFhX28lpJg48y2lErupShwGaZrQ41NEmNYSenTwSw0w+z87NMc4EU1benWCmN2pVYlnVlLydyxG9vSlGK7XpVWSzfMnV7nBMR4siWyw4tqWIuZSbE2tWSIh5AhxztmF2auhP+ou4+RnCaBQ8IRJrdjn0qLFqZiRjvcmDlhcUDyMOn3Bn09tXcmsbbTLHupb1qfhTli3TuPKBuU7e1WNoJ8WdkDCi/yDPB2Q4fj0A9qapDRqtynEcnfvn4cDt2ENG6Q5qJ0+vk6Ni5UvYfe53+AxoYzVcdZfevEH+f5Y1BvLf90QaeOv1/nPy/0ezPfJnHBtF1T1Xn4hb2QUYYzt2/fG8ItVwYzRaVRxt4Ivy6x3aFQgqtmg/+ypNbDmS1kUkqsq/eleM8fGfRMHrUvtlfk37Z9o1eBwzp6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"0x202174\"\n        title=\"\"\n        src=\"/static/38292aa225959be8f28e962a57e63411/5b758/start_vm.png\"\n        srcset=\"/static/38292aa225959be8f28e962a57e63411/e6885/start_vm.png 180w,\n/static/38292aa225959be8f28e962a57e63411/e17e9/start_vm.png 360w,\n/static/38292aa225959be8f28e962a57e63411/5b758/start_vm.png 720w,\n/static/38292aa225959be8f28e962a57e63411/88a47/start_vm.png 744w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n      />\n  </span>\n  </a></p>\n<p>First it reads 0x2800 bytes, then it calls <code>process_byte</code> on every byte. This call should return 1 otherwise it goes to \"Wrong\" message. Aftet this <code>memcmp</code> is called to match two memory regions at addresses <code>0x1320</code> and <code>0x580</code> which also decide Correct/Wrong message.</p>\n<h4>process_byte</h4>\n<p>This is where the challenge starts. First basic block comes to an abrupt <code>hlt</code></p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0a49697d11b9cd612eadcd3ac3003fae/41071/process_byte.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 354px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 114.68926553672316%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAAsSAAALEgHS3X78AAACxUlEQVQ4y5WTbYvcNhDH/f0/RSiUUjhKk1elUMg2fVe6d3t75zs/P9trW7Is2ZJly7Yyzl62CdnmqBiEZqQff41GY/zw2x9vbnY/7Q4//2W/Pd69vb9/1d4djzf7/W0QGW9++fXHmw/vdub7W3fnWDvb/tO2d9+1D47z+8Px/T97g1CqtV7XVf+fMStluZ5R40YISWnH+cC5oIyN4wTW97zrOpillFxsg4HLX1yM8aNlG5g066rGSSg1TNMAW/M8bZFRSAlBAS6QwPR9PwxwBtyBtq1pOYbrk6rWWbbWtW4anaaaEF2W25oxHYaa8yvXVko9OZ6R5mSUuutWzs+mpdyAcdTTpClbYT6/yfp5gA/6puMabuHVw+nUZ6e2bLDwPFRVfVmysuykGkOWIdFeVTZB2UysoPV9FJY1c+zGslAUg99SzosOz8uyrMt/wm7uFzwr6Ikx6XlNFLUIiTAkg1CgOc7qaqle4Ao1o1zkuB2a50XKmfP+1bJDnR8B3t+Frtv0/QghyPb5GSGERT+raX0Ftj3jaCZJws5ShAjTrMUw7t2nHKHzK1+9BMAPAB+OURTS8xFQTlPWEOHkiVyGy9Fv+Rd4fwjzrDuHMBZBQJKkTaqyn7qKNtO4QPBbdYCPAN/eR9kGb9tdNx4OJ8/HLrFKkZuF3RDeoKEse6WWK/DdMbooEzL4ftPzMc6wH+KgSoMmqnoEWYxyvg7Dl0iSrTHznDkOHgZlWyiOWF6wMMaoYXFKiqKb5/WS/1fXPt+KUvnwUMVJa9V2RCM7DxFhXoAxEvDRvkwc4PtPcJhl9PODcd/HalZxF0DaAQnM6gkJdLVUG/z4XMSxoHSBloJ+gjYUYuW97tilUP/206Wr1DQdbNewvYZgXeQrqkFZZ6lmVENvw+I7fxSUDxa0ZJJGGVgSpkmQJOcFzGB+fN2CJLV9/2/T+ghf3Qlu2X0lvAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"process_byte\"\n        title=\"\"\n        src=\"/static/0a49697d11b9cd612eadcd3ac3003fae/41071/process_byte.png\"\n        srcset=\"/static/0a49697d11b9cd612eadcd3ac3003fae/06262/process_byte.png 180w,\n/static/0a49697d11b9cd612eadcd3ac3003fae/41071/process_byte.png 354w\"\n        sizes=\"(max-width: 354px) 100vw, 354px\"\n      />\n  </span>\n  </a></p>\n<p>Looking at the function that starts the VM with KVM_RUN, there's a handler to handle IO and check when machine halts;</p>\n<pre><code class=\"language-c\">if ( ioctl(*(_DWORD *)a2, 0x8090AE81uLL, &#x26;v7) &#x3C; 0 )\n {\n   perror(\"KVM_GET_REGS\");\n   exit(1);\n }\n result = v7.rax;\n if ( !v7.rax )\n   return result;\n v4 = jumper_fn(v7.rax);\n v7.rip = v4;\n if ( ioctl(*(_DWORD *)a2, 0x4090AE82uLL, &#x26;v7) &#x3C; 0 )\n {\n   perror(\"KVM_SET_REGS\");\n   exit(1);\n }\n\n __int64 __fastcall jumper_fn(int a1)\n{\n  __int64 *v1; // rdx\n  __int64 v2; // rdx\n  __int64 result; // rax\n  int i; // [rsp+1Ch] [rbp-14h]\n\n  for ( i = 0; ; ++i )\n  {\n    if ( i >= dword_202170 )\n    {\n      fwrite(\"Error - bug the organizer\\n\", 1uLL, 0x1AuLL, stderr);\n      exit(1);\n    }\n    if ( LODWORD(qword_2020A0[2 * i]) == a1 )\n      break;\n  }\n  v1 = &#x26;qword_2020A0[2 * i];\n  result = *v1;\n  v2 = v1[1];\n  return (unsigned int)result;\n}\n</code></pre>\n<p>Based on what <code>rax\\eax</code> contains <code>rip</code> is updated to new value in the vm according to</p>\n<pre><code class=\"language-python\">   {\n    0xC50B6060: 0x454\n    0x9D1FE433: 0x3ED\n    0x54A15B03: 0x376\n    0x8F6E2804: 0x422\n    0x8AEEF509: 0x389\n    0x3493310D: 0x32C\n    0x59C33D0F: 0x3E1\n    0x968630D0: 0x400\n    0xEF5BDD13: 0x435\n    0x64D8A529: 0x3B8\n    0x5F291A64: 0x441\n    0x05DE72DD: 0x347\n    0xFC2FF49F: 0x3CE\n    }\n</code></pre>\n<p>This opens up a lot of code to analyze with similar  <code>mov eax, const; hlt</code> pattern.\nI use a little r2 and dot to generate this file to look at the code easily.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d141cb154dbbb38c4c0b9710373f623a/ae62f/graph.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 720px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 60.60205094277208%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAACEElEQVQoz31S+2/SQBzvH66/LNMsEh4RkDin080xV94wKMhrjIH4GNMYEdENZFMptNDS9q69tve1QExmsiz55HJ3+X5el2MkgBVmQOcAIxu5fro2LjdCRsgn+rySZws/E6kp/xu7Dub6wZkQqZUUsi8n+zEjxSrxsMwWjZqju8Jt5Cm1MUBLbT8c+neVcFh/9Xi29cX4Tha6tnK7s7TUntiEm5a3+R0WxVkUiyrJnFnMmPmiWRNta0apgxvJi+aOQ2SSXLtYe6SFAmrQzbuDOBgg/m3yQrCIZMPUsuVlxxucJQpVqbk3PkjpuSQ6jCnpDMmnSLZAqmOqC2CNLV2ghgDkP7LjqQJFAPt89O75HR/yupQH90f3vNjjIe5NsunUYcVEGnNpxKXUHLOKukKfTL6Rqx/WqCBXd/g9Ti/VcKuoHpeNeonU6+b7X9actzFv4Qk1HDBTsJ20KoAGEB6z6/31AAo8QU/9YrBlnAFAW+2mJ1xZPynqtTyqChQpNsh08SkYHeCPKbe17mdyXkNvs3KxbXQL0lFESlbN5hv9rKI1TnHnA+qc6p2PZu8T6V0Reb7My1TkZk4uJbRMXMlwuPRaO3KKFbTKoVZwbiqo0TeEyrzBCvG0lsvgfERJtPFXZUW+MMYDIgzN6cAQnM1AF3vod1RIPRd2D3A0oiWOtXc8RQMiDq3ppS0564ii1QP/BRK0eJwuE3f/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"cfg\"\n        title=\"\"\n        src=\"/static/d141cb154dbbb38c4c0b9710373f623a/5b758/graph.png\"\n        srcset=\"/static/d141cb154dbbb38c4c0b9710373f623a/e6885/graph.png 180w,\n/static/d141cb154dbbb38c4c0b9710373f623a/e17e9/graph.png 360w,\n/static/d141cb154dbbb38c4c0b9710373f623a/5b758/graph.png 720w,\n/static/d141cb154dbbb38c4c0b9710373f623a/a00f5/graph.png 1080w,\n/static/d141cb154dbbb38c4c0b9710373f623a/74039/graph.png 1440w,\n/static/d141cb154dbbb38c4c0b9710373f623a/c6a95/graph.png 2160w,\n/static/d141cb154dbbb38c4c0b9710373f623a/ae62f/graph.png 3023w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n      />\n  </span>\n  </a></p>\n<p>Now we can ignore <code>hlt</code> and consider this as one function with the following pseudocode</p>\n<pre><code class=\"language-python\">def process_byte(byte, idx):\n    c = some_arr[idx]\n    if c == 0xff:\n        t = process_byte(byte, idx+8)\n        if t == 1:\n            write_bit(0)\n            return 1\n        else:\n            t = process_byte(byte, idx+0x10)\n            if t == 1:\n                write_bit(1)\n                return 1\n    else:\n        if byte == c:\n            return 1\n        else:\n            return 0\n</code></pre>\n<p>This is basically like a dfs search for the byte provided. Based on where the byte is found in the tree <code>write_bit</code> is called with <code>1\\0</code> which writes the bit to 0x1320.\n0x1320 is used in <code>memcmp</code> to determine the correct/wrong.</p>\n<p>The tree root is at address <code>0x203474</code> which is (0x1300+0x202174) as <code>process_byte</code> is always called from <code>start_vm</code> as <code>process_byte(byte, 0x1300)</code></p>\n<p>The problem now is given some data and the ability to write 1/0 to other region, we make them match.</p>\n<p>The tree looks like this:</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/debf691646df480926f3fac527045631/2a7d8/nodes.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 720px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 58.326817826426904%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABAElEQVQoz42Tiw6EIAwE+/8fq/jAt3KZJksaE8yRNCBuh21Re56nKBjjOJbzPH2tPc3/DIsJ13WVlFLZ972CWhHfR4bFjXVdS865HMfh8C9nLXgF4mqe5/qS0tm779vhzG/IG15LRgxgWZYqAh57KXCMqJHO5A4g5TIomTUtaJXLGIbBc9ETtYfTNDlADnXTOGhdEIM8nMqQA0mSO60JhBxAUmyFYBzYdZ3noe373l0aCeoFM8+CUBIzsW2bJ6rn0hG0BiAa4wFH0NnAPqcCE1CfU+wxAPbJwQha4IYzlaiPG4FaAJCZoERgsRpdoPT29TeoX7jgD1J/AakCQmbQ/wCe9a46d+XEUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"node\"\n        title=\"\"\n        src=\"/static/debf691646df480926f3fac527045631/5b758/nodes.png\"\n        srcset=\"/static/debf691646df480926f3fac527045631/e6885/nodes.png 180w,\n/static/debf691646df480926f3fac527045631/e17e9/nodes.png 360w,\n/static/debf691646df480926f3fac527045631/5b758/nodes.png 720w,\n/static/debf691646df480926f3fac527045631/a00f5/nodes.png 1080w,\n/static/debf691646df480926f3fac527045631/74039/nodes.png 1440w,\n/static/debf691646df480926f3fac527045631/c6a95/nodes.png 2160w,\n/static/debf691646df480926f3fac527045631/2a7d8/nodes.png 2558w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n      />\n  </span>\n  </a></p>\n<p>Based on whether a right/left is taken to traverse to the leaf node a 1/0 is written respectively. This way we can write to</p>\n<p>Now we have some bitstrings for each leaf node and the final bit string to be written, we need to find the right order that will fit in 0x2800 bytes.</p>\n<pre><code class=\"language-python\">  {\n  '0001110': '4'\n  '11111010': 'e'\n  '110110': '6'\n  '0001010': '?'\n  '00111010': '\\n'\n  '1011010': 'r'\n  '10100': 'o'\n  '000010': '3'\n  '01100': '1'\n  '1101010': 'd'\n  '1101110': 'u'\n  '1': '\\x00'\n  '100010': '7'\n  '1100100': '5'\n  '110010': 'i'\n  '010010': 'f'\n  '10000110': 'n'\n  '0011010': 'g'\n  '010110': 's'\n  '11000110': '{'\n  '000': '0'\n  '00000110': 'm'\n  '01111010': '2'\n  '10111010': '.'\n  '01000110': 'x'\n  '0100100': '}'\n  '0101110': 'l'\n  '11100': 't'\n  '100110': 'a'\n  '0101010': 'b'\n  '000100': 'w'\n  '1001110': 'h'\n  '1001010': 'c'\n  '11110': ' '\n  }\n</code></pre>\n<p>This is similar to word break problem and can be solved recursively/dp.\nDump the reference memory region <code>0x580</code> of length <code>0x54a</code> and solve.</p>\n<pre><code class=\"language-python\">dump = open(\"dump\", \"rb\").read()\ns = \"\".join(map(lambda x:format(x, '08b')[::-1], map(ord, list(dump))))\n\ndef solve(str, n, result):\n    for i in xrange(1,n+1):\n        substr = str[:i]\n        if substr in smi:\n            if i == n:\n                result += substr\n                print result\n                break\n            solve(str[i:], n-i, result+substr+\" \")\n\nsolve(s, len(s), \"\")\n</code></pre>\n<p>The string that was generated was a TAR archive with the flag.\n<a href=\"/solve-1b28c3883fcaf1781b3fe9639c7e9910.py\">Full script</a></p>","relativePath":"writeups/csaw-quals-2018/reverse/kvm/sudhackar"}}