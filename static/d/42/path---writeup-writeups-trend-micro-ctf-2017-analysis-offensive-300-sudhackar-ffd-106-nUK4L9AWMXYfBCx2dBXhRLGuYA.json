{"pageContext":{"html":"<p><a href=\"ctf=trend-micro-ctf-2017\"></a>\n<a href=\"type=analysis,reverse\"></a>\n<a href=\"tags=android\"></a>\n<a href=\"tools=jd-gui,dex2jar\"></a>\n<a href=\"techniques=bruteforce\"></a></p>\n<h1>analysis-offensive 300</h1>\n<p><em>Disclaimer : This is not the smart way to do this, but its easy if you have an android development setup.</em></p>\n<p>So we have an apk file.</p>\n<pre><code class=\"language-bash\">$ file TrendGacha.apk\nTrendGacha.apk: Zip archive data, at least v2.0 to extract\n$ unzip -qq TrendGacha.apk -d TrendGacha\n$ ls TrendGacha\nAndroidManifest.xml  classes.dex  lib  META-INF  res  resources.arsc\n$ cd TrendGacha\n$ ~/tools/dex2jar/d2j-dex2jar.sh classes.dex\ndex2jar classes.dex -> ./classes-dex2jar.jar\n</code></pre>\n<p>I also installed the apk on a device to test it.</p>\n<p><img src=\"menu.png\" alt=\"Main\"></p>\n<p>The functions are quite simple. When you click on <code>GET GACHA!</code> it'll choose a character of the flag and give it to you. All your leaked chars can then be seen later in the <code>HISTORY</code>.</p>\n<p>Looking in the output of jd-gui on the jar. The code for <code>GET GACHA!</code>.</p>\n<pre><code class=\"language-java\">public void run()\n      {\n        Intent localIntent = new Intent(\"com.tm.ctf.trendgacha.GET_GACHA\");\n        if (a.N() == null) {\n          a.b(a.this.i().getApplicationContext());\n        }\n        a.N().sendBroadcast(localIntent);\n        a.a(a.this, true);\n      }\n</code></pre>\n<p>So the button sends a com.tm.ctf.trendgacha.GET_GACHA intent via broadcast which is then handled by GachaBroadcastReceiver.</p>\n<pre><code class=\"language-java\">public void onReceive(Context paramContext, Intent paramIntent)\n  {\n    Log.i(a, \"onReceive: action=\" + paramIntent.getAction());\n    if (!paramIntent.getAction().equals(\"com.tm.ctf.trendgacha.GET_GACHA\")) {\n      return;\n    }\n    paramIntent = paramIntent.getExtras();\n    if (paramIntent != null) {}\n    for (int i = Integer.valueOf(paramIntent.getString(\"TryLoop\", \"1\")).intValue();; i = 1)\n    {\n      for (int j = 0; j &#x3C; i; j++)\n      {\n        d.b(paramContext.getApplicationContext());\n        int n = d.a(paramContext.getApplicationContext());\n        paramIntent = GachaAPI.getGacha(n);\n        int k = paramIntent[0];\n        char c1 = (char)paramIntent[1];\n        d.a(paramContext.getApplicationContext(), k, c1);\n        int m = d.b(paramContext.getApplicationContext(), k, c1);\n        Log.i(a, \"TrialCount: \" + n + \", Order: \" + k + \", Gacha: \" + c1 + \", Count: \" + m);\n        paramIntent = c.iterator();\n        while (paramIntent.hasNext()) {\n          ((b)paramIntent.next()).b_();\n        }\n        Toast.makeText(paramContext, \"Got \\\"\" + k + \"-\" + c1 + \"\\\" !\", 0).show();\n        if (n &#x3C; 10) {\n          Toast.makeText(paramContext, \"Check History!\", 0).show();\n        }\n      }\n      break;\n    }\n  }\n}\n</code></pre>\n<p>This will leak a byte of the flag. We also see a variable <code>TryLoop</code> which will repeat the leak <code>TryLoop</code> times. Whenever we press the <code>GET GACHA!</code> button <code>TRIAL_COUNT</code> is increased in the SharedPreferences. The <code>GachaAPI.getGacha</code> is called on the value of <code>TRIAL_COUNT</code>. Its good that we can broadcast intents via adb so that we can set <code>TRIAL_COUNT</code> to a very high value.</p>\n<pre><code class=\"language-bash\">$ adb shell am broadcast -a com.tm.ctf.trendgacha.GET_GACHA -e TryLoop 100\nBroadcasting: Intent { act=com.tm.ctf.trendgacha.GET_GACHA (has extras) }\nBroadcast completed: result=0\n</code></pre>\n<p>Hoever this only leaks a few bytes of the flag which we can view in History. I tried to set the number to 10000 and more but the process was slow and I got bored.</p>\n<p><img src=\"history.png\" alt=\"History\"></p>\n<p>Looking into the source of <code>GachaAPI.getGacha</code> we see that it loads a native library.</p>\n<pre><code class=\"language-java\">package com.tm.ctf.trendgacha;\n\npublic class GachaAPI\n{\n  static\n  {\n    System.loadLibrary(\"native-lib\");\n  }\n\n  public static native int[] getGacha(int paramInt);\n}\n</code></pre>\n<p>If only I could run <code>getGacha</code> with my parameters. I never did much development in Android, so I downloaded Android Studio, added <code>com.tm.ctf.trendgacha</code> in a sample app from the decompiled source and added the jniLibs to include <code>native-lib</code>. I added the following code in an activity to retrieve and save the flag to a file.</p>\n<pre><code class=\"language-java\">protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_card_view);\n        Log.i(TAG,\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\");\n        int i = 1;\n        for(i = 1 ; i &#x3C; 1000000 ; ++i){\n            int[] x = GachaAPI.getGacha(i);\n            appendLog(\"Result : \" +(char)x[1] + \" : \" + Arrays.toString(x) );\n        }\n    }\n</code></pre>\n<p>This succesfully gave me the flag. Just later I realized that I could have controlled the parameter to <code>GachaAPI.getGacha</code> from the <code>TRIAL_COUNT</code> in SharedPreferences. SharedPreferences are usually saved in XML format in /data/data/&#x3C; appname >/shared_prefs/*.xml. But we need root on the device to pull and push these files. So to test this I set up a new AVD (already rooted!) and installed the app.</p>\n<pre><code class=\"language-bash\">$ ~/Android/Sdk/platform-tools/adb pull /data/data/com.tm.ctf.trendgacha/shared_prefs/PREFERENCES.xml\n/data/data/com.tm.ctf.trendgacha/shared_... pulled. 0.2 MB/s (1892 bytes in 0.009s)\n</code></pre>\n<p>In PREFERENCES.xml I increased the <code>TRIAL_COUNT</code>.</p>\n<pre><code class=\"language-xml\">&#x3C;int name=\"TRIAL_COUNT\" value=\"3000863\" />\n</code></pre>\n<p>And then pushed it back and restarted the application.</p>\n<pre><code class=\"language-bash\">$  ~/Android/Sdk/platform-tools/adb push PREFERENCES.xml /data/data/com.tm.ctf.trendgacha/shared_prefs/PREFERENCES.xml\nPREFERENCES.xml: 1 file pushed. 0.2 MB/s (1893 bytes in 0.009s)\n$  ~/Android/Sdk/platform-tools/adb  shell am broadcast -a com.tm.ctf.trendgacha.GET_GACHA -e TryLoop 100\nBroadcasting: Intent { act=com.tm.ctf.trendgacha.GET_GACHA (has extras) }\nBroadcast completed: result=0\n</code></pre>\n<p>This will give us the flag.</p>\n<p><img src=\"final.png\" alt=\"Flag\"></p>"}}