{"pageContext":{"html":"<p><a href=\"ctf=ekoparty-ctf-2015\"></a>\n<a href=\"type=reversing\"></a>\n<a href=\"tags=image,C#\"></a>\n<a href=\"tools=Telerik-JustDecompile,PIL\"></a>\n<a href=\"techniques=no-patch\"></a></p>\n<h1>Patch me (rev50)</h1>\n<p>We have a <a href=\"/rev50-f9fefe26c15729fb13cba49265169c8e.zip\">zip</a>.\nExtract and we get</p>\n<pre><code class=\"language-bash\">$ file *\nSecureImageViewer.exe: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows\nsecureimage.xml:       XML document text\n</code></pre>\n<p>.Net assembly can be very easy decompiled. I use <a href=\"http://www.telerik.com/products/decompiler.aspx\">Telerik JustDecompile</a> to decompile the code. Here is the code that does the main job of decoding the xml to an image.</p>\n<pre><code class=\"language-cs\">protected void open(object sender, EventArgs e)\n    {\n        int num = 201527;\n        int[] numArray = new int[100001];\n        int num1 = 0;\n        using (FileStream fileStream = File.OpenRead(\"secureimage.xml\"))\n        {\n            numArray = (int[])(new XmlSerializer(typeof(int[]))).Deserialize(fileStream);\n        }\n        for (int i = 0; i &#x3C; 100000; i++)\n        {\n            num1 = num1 + numArray[i];\n        }\n        if (num1 != numArray[100000])\n        {\n            MessageDialog messageDialog = new MessageDialog(null, 1, 3, 1, \"Corrupted Image\", new object[0]);\n            messageDialog.Run();\n            messageDialog.Destroy();\n            return;\n        }\n        GC gC = new GC(this.graph.get_GdkWindow());\n        gC.set_RgbFgColor(new Color(51, 102, 153));\n        this.graph.get_GdkWindow().GetImage(0, 0, 500, 200);\n        for (int j = 0; j &#x3C; 500; j++)\n        {\n            for (int k = 0; k &#x3C; 200; k++)\n            {\n                if ((numArray[j + k * 500] ^ num) == 3368601)\n                {\n                    this.graph.get_GdkWindow().DrawPoint(gC, j, k);\n                }\n                num = num * 100673 + 15485867;\n            }\n        }\n    }\n</code></pre>\n<p>The algorithm is easier to implement in python than to patch the binary xD.\nThe xml provided here fails the check </p>\n<pre><code>for (int i = 0; i &#x3C; 100000; i++)\n        {\n            num1 = num1 + numArray[i];\n        }\n        if (num1 != numArray[100000])\n</code></pre>\n<p>I would write python instead.</p>\n<pre><code class=\"language-python\">>>> from PIL import Image\n>>> size=500,200\n>>> num=201527\n>>> num1=0\n>>> for i in xrange(100000):\n...     num1+=arr[i]\n... \n>>> num1\n245665872900\n>>> num1=0\n>>> arr[100000]\n0\n>>> im = Image.new(\"RGB\", size, \"white\")\n>>> pix=im.load()\n>>> for j in xrange(0,500):\n...     for k in xrange(0,200):\n...             if (arr[j+k*500]^num) == 3368601:\n...                     pix[j,k]=(0,0,0)\n...             num=((num*100673)+15485867)&#x26;0xffffffff\n... \n>>> im.show()\n>>> \n</code></pre>\n<p>Will give me <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5d9c2fd22e0aed34bbbbdb461dec1581/a5510/final.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 419px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 30.310262529832936%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3ZgB/8QAFxABAQEBAAAAAAAAAAAAAAAAAQACEf/aAAgBAQABBQLjOkhW/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFRABAQAAAAAAAAAAAAAAAAAAEDH/2gAIAQEABj8Cr//EABgQAAMBAQAAAAAAAAAAAAAAAAABETHw/9oACAEBAAE/IeaHDVwQWn//2gAMAwEAAgADAAAAEAAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAIDAQAAAAAAAAAAAAAAAQAhEVFxgf/aAAgBAQABPxCzXiMB1FQLzBYZ5P/Z'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"final\"\n        title=\"\"\n        src=\"/static/5d9c2fd22e0aed34bbbbdb461dec1581/a5510/final.jpg\"\n        srcset=\"/static/5d9c2fd22e0aed34bbbbdb461dec1581/e30fc/final.jpg 180w,\n/static/5d9c2fd22e0aed34bbbbdb461dec1581/0eede/final.jpg 360w,\n/static/5d9c2fd22e0aed34bbbbdb461dec1581/a5510/final.jpg 419w\"\n        sizes=\"(max-width: 419px) 100vw, 419px\"\n      />\n  </span>\n  </a>.</p>\n<p>Flag</p>\n<blockquote>\n<p>EKO{n1L+P4tch}</p>\n</blockquote>"}}