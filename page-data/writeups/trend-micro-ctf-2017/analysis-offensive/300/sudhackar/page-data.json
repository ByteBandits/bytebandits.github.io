{"componentChunkName":"component---src-templates-writeup-js","path":"/writeups/trend-micro-ctf-2017/analysis-offensive/300/sudhackar","result":{"pageContext":{"html":"<p><a href=\"ctf=trend-micro-ctf-2017\"></a>\n<a href=\"type=analysis,reverse\"></a>\n<a href=\"tags=android\"></a>\n<a href=\"tools=jd-gui,dex2jar\"></a>\n<a href=\"techniques=bruteforce\"></a></p>\n<h1>analysis-offensive 300</h1>\n<p><em>Disclaimer : This is not the smart way to do this, but its easy if you have an android development setup.</em></p>\n<p>So we have an apk file.</p>\n<pre><code class=\"language-bash\">$ file TrendGacha.apk\nTrendGacha.apk: Zip archive data, at least v2.0 to extract\n$ unzip -qq TrendGacha.apk -d TrendGacha\n$ ls TrendGacha\nAndroidManifest.xml  classes.dex  lib  META-INF  res  resources.arsc\n$ cd TrendGacha\n$ ~/tools/dex2jar/d2j-dex2jar.sh classes.dex\ndex2jar classes.dex -> ./classes-dex2jar.jar\n</code></pre>\n<p>I also installed the apk on a device to test it.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 720px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75e762d5b826f80911a339321b42978d/9d22c/menu.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAIAAAAGkY33AAAACXBIWXMAAAsSAAALEgHS3X78AAAEWElEQVRIx5VU608idxSdv6jpJtWErcsCPmDXdmNpotumH/rJKEltt7VNGs1+qdnWpL6aVI02ZaPV1UqLMqwIIj6jVEFkUdQqKqbiCzUVgWGePTAVEdBtb27IzI977jn33t9coidPpnvwSKdW//il6vuP7j1/I0d7J0f75ltJf34np69A9UJR9EJeOPDOI52iuFWd+8PHuQMFxYRBWgQflMj0UsVveTJ9zj19rnQoL/+aSwtJmZK8ryTlKlJapJfn/56fj1dipPDdWc2TOc2T+c+//uPTr+yffDGr+WxY8XBY/uDKZaq43084XqVKi0pteagmDHcVI6qS0fcej6o/sL7/IdxS8ph8u8AgkRvuyi5dcc0lcqO0CE74xyd3rLYts3XbYt02iz66Yxv322b8ttlLn/CPwyeTvmObgBNChvGCwMWdYQQ/I/zJCmEucchnRBIxirrmUYoVDvnjec7xC+c2CT47vzvM77t4IUDTUfybGkzQSYvFYhzPBo+d3za4n/0UaBr8u530PdX5n+m9Tzvnvvnu1O6EBGCSiBQw4DTDRiN7zj2PfmHR8OuKlXQbBud+1q6OTHp1y6G/ggzPIig7WDQuXrJAc0yI8kXY1ZgQEatlWDYtMgs4RsVQG03FGJqnKYGm6HipOInFXg9OdoAGDjkyMK8BMwzDcRzLsnjgeZ7NEHwjGACwHR4erq2tra+v7+7unp+fZ8VnZ97c3FxaWlpcXPR4PK8Stre3B3xaCURanYgIBoNutxsAl8u1sbEBcuRaWFjI5CcyNXu9XsCgeWVlBeDV1VUox4lIHo1Gk/xEGhL/LS8vz8/PA4wsDocDKgYGBux2+/Hxcfzm8/GpIzILOBKJQKfJZAKVN2FIpFQqu7q6tra20IWxsTGkC4VCCE6vGRMC59TUFNRCAqpForKyspaWFuQ9Ojra3t5GL09PT1HCNTBFUVDl9/vNZjNIkCUQCLS3tzc0NDQ1NYEKgpE9i2zQivXU19e3traCwWazgb+ysrK6ulqj0XR3d5+dnSEgvWFiVrDV1dV1dnbihvT09FgsFpBXVVXpdLri4uLS0lJU3tfXFw6Hr5jFPvX395Mk6XQ6KyoqampqUBjS4ZI0NjYODQ319vYGE1ZbW3twcCDyE6gTT8DgFMxtbW2Qh/QdHR2YjdFoLCkpQecQ4/P5UDx6nlROJAuemJjQ6/X7+/uoHFoAKC8vl0gkyIvo6enp5uZmcdTU5TK5api40y4uLk5OTvCA6wUJGBWekVSr1cb3BMdRWddQNGHiJwUAZGNguM8YFXoR3y3/fuS3b5LE54E7hIZjZmiEKDX23zeJuAbEWwFF/2OTiPzAgPAmZBYwm2JMwlJPbgODLZSwi3AYbRd/QwmHoXm3NQwip2dmRsxmy+goaTS+8ngCBwdWq9X48uWwybTi9abO6RoYCvEfxosNhLu54HDgSh0eHbmWluLucm36fDeCU8coVovX1Og0JOwf4/cpwV6lC48AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Main\"\n        title=\"Main\"\n        src=\"/static/75e762d5b826f80911a339321b42978d/91043/menu.png\"\n        srcset=\"/static/75e762d5b826f80911a339321b42978d/0ca2e/menu.png 180w,\n/static/75e762d5b826f80911a339321b42978d/34b33/menu.png 360w,\n/static/75e762d5b826f80911a339321b42978d/91043/menu.png 720w,\n/static/75e762d5b826f80911a339321b42978d/9d22c/menu.png 1080w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The functions are quite simple. When you click on <code>GET GACHA!</code> it'll choose a character of the flag and give it to you. All your leaked chars can then be seen later in the <code>HISTORY</code>.</p>\n<p>Looking in the output of jd-gui on the jar. The code for <code>GET GACHA!</code>.</p>\n<pre><code class=\"language-java\">public void run()\n      {\n        Intent localIntent = new Intent(\"com.tm.ctf.trendgacha.GET_GACHA\");\n        if (a.N() == null) {\n          a.b(a.this.i().getApplicationContext());\n        }\n        a.N().sendBroadcast(localIntent);\n        a.a(a.this, true);\n      }\n</code></pre>\n<p>So the button sends a com.tm.ctf.trendgacha.GET_GACHA intent via broadcast which is then handled by GachaBroadcastReceiver.</p>\n<pre><code class=\"language-java\">public void onReceive(Context paramContext, Intent paramIntent)\n  {\n    Log.i(a, \"onReceive: action=\" + paramIntent.getAction());\n    if (!paramIntent.getAction().equals(\"com.tm.ctf.trendgacha.GET_GACHA\")) {\n      return;\n    }\n    paramIntent = paramIntent.getExtras();\n    if (paramIntent != null) {}\n    for (int i = Integer.valueOf(paramIntent.getString(\"TryLoop\", \"1\")).intValue();; i = 1)\n    {\n      for (int j = 0; j &#x3C; i; j++)\n      {\n        d.b(paramContext.getApplicationContext());\n        int n = d.a(paramContext.getApplicationContext());\n        paramIntent = GachaAPI.getGacha(n);\n        int k = paramIntent[0];\n        char c1 = (char)paramIntent[1];\n        d.a(paramContext.getApplicationContext(), k, c1);\n        int m = d.b(paramContext.getApplicationContext(), k, c1);\n        Log.i(a, \"TrialCount: \" + n + \", Order: \" + k + \", Gacha: \" + c1 + \", Count: \" + m);\n        paramIntent = c.iterator();\n        while (paramIntent.hasNext()) {\n          ((b)paramIntent.next()).b_();\n        }\n        Toast.makeText(paramContext, \"Got \\\"\" + k + \"-\" + c1 + \"\\\" !\", 0).show();\n        if (n &#x3C; 10) {\n          Toast.makeText(paramContext, \"Check History!\", 0).show();\n        }\n      }\n      break;\n    }\n  }\n}\n</code></pre>\n<p>This will leak a byte of the flag. We also see a variable <code>TryLoop</code> which will repeat the leak <code>TryLoop</code> times. Whenever we press the <code>GET GACHA!</code> button <code>TRIAL_COUNT</code> is increased in the SharedPreferences. The <code>GachaAPI.getGacha</code> is called on the value of <code>TRIAL_COUNT</code>. Its good that we can broadcast intents via adb so that we can set <code>TRIAL_COUNT</code> to a very high value.</p>\n<pre><code class=\"language-bash\">$ adb shell am broadcast -a com.tm.ctf.trendgacha.GET_GACHA -e TryLoop 100\nBroadcasting: Intent { act=com.tm.ctf.trendgacha.GET_GACHA (has extras) }\nBroadcast completed: result=0\n</code></pre>\n<p>Hoever this only leaks a few bytes of the flag which we can view in History. I tried to set the number to 10000 and more but the process was slow and I got bored.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 720px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ed4f5ff6ba9f812ad42ee2f156038852/9d22c/history.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAIAAAAGkY33AAAACXBIWXMAAAsSAAALEgHS3X78AAACV0lEQVRIx+1QS3PSYBT9fpFjnVKtGiCB8iiMil3p6MIZVy668PEr3DmjW7px6kyxHaA8CoVSN/YPUB5DgEELIUAg4ZGQBPBAnNpRdy7lzp2be07Oufcm5CNlDWzeD/gevH/lfPuE2rm26r9h8q+Y/NdXjdxZMX2yu3YZxy69see9F2A8Hx6uvXt2c8/uJUHKHqLsYdoVtDk+U/T+mnnfRB3csgTv2n6leSNsdYYtTsjCZscBbd9nbIAkZvOcPn0epd1xxvP1xcuz7Tdn26/BRCxOkPO0un6mZZ6Ree+OWeY8Cd2xRZjN0G0GGXP7kr5Hya3HR96t0DpjkH/N4DqNJOXjdO4wVst8qZ6c1tKZcjxRPIxWj9OlRIpNpsDnY0eoxXgCEJp8NA5YSZ1UUhkiK8p3np/NZucsy7Vamq5XG3XAltjrSeJkNv3W5AC7kjSSZTRtSULlhQ4vCGTQ7/PN5nQ6Pc9m0YyGwwrLaqraEwRJFAFr1epE13mO63Y6iiwXcjld0wAbFxdkNBpxHKdp2ng81nVdluVWq4WmXq+LoggebyeTSXMRaECqqtrpdCAjkiRls1mou90uBg0Gg1KphEOKxaIgCDDXajXcmc/nWZaFud1uAxYKBcD5Zp7njZHD4RBTAeHp9XoYhHOMhQYE32g0oIEYywgeWIJVhhSVX/w/kDgMX1Eul43NxkU4EzvAYytRFAWXYyRsyiLAAvb7fSgwDhsMCAF24gTU0SIIOnwwKhTqIozGIC8b1Ku8toi5GeMv65/xG38VEvUfYmlempfmpfm/Nf8A6KGaghkr4TsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"History\"\n        title=\"History\"\n        src=\"/static/ed4f5ff6ba9f812ad42ee2f156038852/91043/history.png\"\n        srcset=\"/static/ed4f5ff6ba9f812ad42ee2f156038852/0ca2e/history.png 180w,\n/static/ed4f5ff6ba9f812ad42ee2f156038852/34b33/history.png 360w,\n/static/ed4f5ff6ba9f812ad42ee2f156038852/91043/history.png 720w,\n/static/ed4f5ff6ba9f812ad42ee2f156038852/9d22c/history.png 1080w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Looking into the source of <code>GachaAPI.getGacha</code> we see that it loads a native library.</p>\n<pre><code class=\"language-java\">package com.tm.ctf.trendgacha;\n\npublic class GachaAPI\n{\n  static\n  {\n    System.loadLibrary(\"native-lib\");\n  }\n\n  public static native int[] getGacha(int paramInt);\n}\n</code></pre>\n<p>If only I could run <code>getGacha</code> with my parameters. I never did much development in Android, so I downloaded Android Studio, added <code>com.tm.ctf.trendgacha</code> in a sample app from the decompiled source and added the jniLibs to include <code>native-lib</code>. I added the following code in an activity to retrieve and save the flag to a file.</p>\n<pre><code class=\"language-java\">protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_card_view);\n        Log.i(TAG,\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\");\n        int i = 1;\n        for(i = 1 ; i &#x3C; 1000000 ; ++i){\n            int[] x = GachaAPI.getGacha(i);\n            appendLog(\"Result : \" +(char)x[1] + \" : \" + Arrays.toString(x) );\n        }\n    }\n</code></pre>\n<p>This succesfully gave me the flag. Just later I realized that I could have controlled the parameter to <code>GachaAPI.getGacha</code> from the <code>TRIAL_COUNT</code> in SharedPreferences. SharedPreferences are usually saved in XML format in /data/data/&#x3C; appname >/shared_prefs/*.xml. But we need root on the device to pull and push these files. So to test this I set up a new AVD (already rooted!) and installed the app.</p>\n<pre><code class=\"language-bash\">$ ~/Android/Sdk/platform-tools/adb pull /data/data/com.tm.ctf.trendgacha/shared_prefs/PREFERENCES.xml\n/data/data/com.tm.ctf.trendgacha/shared_... pulled. 0.2 MB/s (1892 bytes in 0.009s)\n</code></pre>\n<p>In PREFERENCES.xml I increased the <code>TRIAL_COUNT</code>.</p>\n<pre><code class=\"language-xml\">&#x3C;int name=\"TRIAL_COUNT\" value=\"3000863\" />\n</code></pre>\n<p>And then pushed it back and restarted the application.</p>\n<pre><code class=\"language-bash\">$  ~/Android/Sdk/platform-tools/adb push PREFERENCES.xml /data/data/com.tm.ctf.trendgacha/shared_prefs/PREFERENCES.xml\nPREFERENCES.xml: 1 file pushed. 0.2 MB/s (1893 bytes in 0.009s)\n$  ~/Android/Sdk/platform-tools/adb  shell am broadcast -a com.tm.ctf.trendgacha.GET_GACHA -e TryLoop 100\nBroadcasting: Intent { act=com.tm.ctf.trendgacha.GET_GACHA (has extras) }\nBroadcast completed: result=0\n</code></pre>\n<p>This will give us the flag.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 720px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/88576b6d734f8b047ff4102c71c1539c/9d22c/final.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAAsSAAALEgHS3X78AAADgUlEQVRIx+1WW0tUURQ+qA/6ohjqi/4CM800BMF6CFMJ08RBQygCH8L8E0pE4Ks+6JuXV1HTSFHpJQoKUpou6lydu3PN+4y3r/3taU9HmwnB3mrDYp/zrbW+9a11ZvY5mqZpuIjl5OaiuKQEhUVFuJSXB623tAK9JdfQW1qJ3isV6Llcjp7iMmFX4xj90ip/30X807Lr6KuqwfPKajwrr4L2urYR79ofYr76Ft40t+ND5xO8f/QYb9seYPFGHRZvJrP6U/fzNbVYqLmNBRGvzTTcw8vGVszUN2HmTgtmWzswa+jAq5b7Amv+aU2/9oZmTNc1YVpiTXhRdzeO1ccxzWuxwvLJiLDbDY/ZAr/NDp/A7F++IuxyY/3bCtwmM0JOFyzGzxJzrq3BI2KCDqe4NiHkiuf6rDZou/v7cHk94Pq4vAyH24XY4SFs6+sSC4SCiGxuInpwAKvdLjF/MIitnR0cnZzA7nBIzOPzwe31CsLdXUTCYRwfH2NdkGyK5H1RxOl04kCQbG1tYVck7+3twe/34+joCCFB+D0SQSwahdVikXHkCAi/JGRyLBaTdijUkTAQCMhkm82GsAgm7vF4ZGG3GI/L5ZLXLEQfi21sbEDb3t7GmpiJrBwKYUeooRFjgkO0RNVUQZITtilapwjmkISL8WazOa7QK3qnU7Yn7pkcFG2xMncSRkV7iZZFYWL0Uy19zGO+RofJZJJqqIxtUzWTVWWSMsEi5sXFeJVjNBqlj2Ni+wmFdHJXD8UnnhrVkJiFiFmtVhnH+VIlFbI4OyIPTSpcWVmRlZnAYAatrq5KjDNUyZwXCbnzQbEgydgVd5rG6uqJMZFzoHTORs2VBZQaYhHxk1GYIlO/Eo03JOMNgxmkx3ivEvX7WWUJhYpZXyUZpidIhiUIz1a4qP0n/E/4bxDq/1Y8OHlscddfp/rb/VEhg1OtVGQpFVIF3x1LS0sYGBjA4OAghoaG0N/fj7m5ucSpcy6FipCrr68PbW1t6OrqQmdnJwwGA7q7u+WpzqPu3C0zkOchX6ETExOYnJzE1NQUxsfHpWpFlpSQp3MyU28/LrZP4yJZqhz5ksJfXtrY2Bhoo6OjGB4elqYwhetN7xsZGZGmx7XzfqmmpaUlxbOzs09jGRkZUJaTk4P8/HzoMVqe+NQtKChAVlYW0tPTJcY9V3wOFxYWIjMzM4H/AOP0s6vfS/FJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Flag\"\n        title=\"Flag\"\n        src=\"/static/88576b6d734f8b047ff4102c71c1539c/91043/final.png\"\n        srcset=\"/static/88576b6d734f8b047ff4102c71c1539c/0ca2e/final.png 180w,\n/static/88576b6d734f8b047ff4102c71c1539c/34b33/final.png 360w,\n/static/88576b6d734f8b047ff4102c71c1539c/91043/final.png 720w,\n/static/88576b6d734f8b047ff4102c71c1539c/9d22c/final.png 1080w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","relativePath":"writeups/trend-micro-ctf-2017/analysis-offensive/300/sudhackar"}}}