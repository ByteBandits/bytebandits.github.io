{"componentChunkName":"component---src-templates-writeup-js","path":"/writeups/teaser-dragon-ctf-2019/misc/PlayCAP/jaiverma","result":{"pageContext":{"html":"<p><a href=\"ctf=teaser-dragon-ctf-2019\"></a>\n<a href=\"type=misc\"></a>\n<a href=\"tags=pcap,html5,usb\"></a>\n<a href=\"tools=wireshark,tshark\"></a></p>\n<h1>PlayCAP</h1>\n<p>We are given an <a href=\"/86d8b2c5c8a5de0e0904a495569f0120/app.html\">HTML5 application</a> and a <a href=\"/99992d06f70b4a62ccf3d4324ce1ef16/PlayCAP.pcapng\">pcagng</a>.</p>\n<p>The packet capture file has a bunch of USB traffic (<code>URB Interrupt</code> packets). More information about the USB filter fields can be found at the <a href=\"https://www.wireshark.org/docs/dfref/u/usb.html\">Wireshark USB reference page</a>.</p>\n<pre><code class=\"language-sh\">$ tshark -r ../PlayCAP.pcapng -V | less\nFrame 1: 36 bytes on wire (288 bits), 36 bytes captured (288 bits) on interface 0\n    Interface id: 0 (\\\\.\\pipe\\wireshark_extcap_\\\\.\\USBPcap1_20190918154451)\n        Interface name: \\\\.\\pipe\\wireshark_extcap_\\\\.\\USBPcap1_20190918154451\n    Encapsulation type: USB packets with USBPcap header (152)\n    Arrival Time: Sep 18, 2019 19:16:10.716963000 IST\n    [Time shift for this packet: 0.000000000 seconds]\n    Epoch Time: 1568814370.716963000 seconds\n    [Time delta from previous captured frame: 0.000000000 seconds]\n    [Time delta from previous displayed frame: 0.000000000 seconds]\n    [Time since reference or first frame: 0.000000000 seconds]\n    Frame Number: 1\n    Frame Length: 36 bytes (288 bits)\n    Capture Length: 36 bytes (288 bits)\n    [Frame is marked: False]\n    [Frame is ignored: False]\n    [Protocols in frame: usb]\nUSB URB\n    [Source: host]\n    [Destination: 1.8.0]\n    USBPcap pseudoheader length: 28\n    IRP ID: 0xffffda046b5cc010\n    IRP USBD_STATUS: USBD_STATUS_SUCCESS (0x00000000)\n    URB Function: URB_FUNCTION_GET_DESCRIPTOR_FROM_DEVICE (0x000b)\n    IRP information: 0x00, Direction: FDO -> PDO\n        0000 000. = Reserved: 0x00\n        .... ...0 = Direction: FDO -> PDO (0x0)\n    URB bus id: 1\n</code></pre>\n<p>Checking the vendor (<code>0x57e</code>) and product (<code>0x2009</code>) ids of the USB device with help from google tells us the traffic is from a <em>Nintendo Switch controller</em> : <a href=\"https://github.com/360Controller/360Controller/issues/632\">360Controller/issues/632</a>.</p>\n<pre><code class=\"language-sh\">tshark -r ../PlayCAP.pcapng -e usb.idProduct -e usb.idVendor -Tfields  | less\n</code></pre>\n<p>The following kernel patch has more information about the specific fields we're interested in : <a href=\"https://patchwork.kernel.org/patch/10761581\">patch/10761581/</a>.</p>\n<p>Going through <a href=\"/86d8b2c5c8a5de0e0904a495569f0120/app.html\">app.html</a>, we find the following interesting information:</p>\n<pre><code class=\"language-javascript\">...\n      checkChange(pad.buttons, 'left', 14);  // Direction buttons.\n      checkChange(pad.buttons, 'right', 15);\n      checkChange(pad.buttons, 'up', 12);\n      checkChange(pad.buttons, 'down', 13);\n      checkChange(pad.buttons, 'reset', 3);  // X\n      checkChange(pad.buttons, 'select', 1);  // A\n...\n</code></pre>\n<p>We can control the on-screen keyboard with the <code>handleButtons</code> function.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 720px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/db23be24b31e5d031f00b39a96cbd7de/714c9/app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.49315068493151%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABsklEQVQoz2P49fPnzh0z95xdfujewWOPTm29f+DAo5MH7x46/vAUhDx8/8ixhycP3zsKYt87DGQfuHf4KJhk+Pzzu+EUI9NptpKd8vY91lMz9StqXWS65AwmWcm1y+tNslDqVtWZaK7eq64/yVylU1Fzgplku5zmBFO5TkWGLz++afXpG0+xlmxXMJ5g7dmg7tnrINuhYDDZRrJNQXeSpWIXUJuVco+m7kQLqXZF7YmWEkBygoVcpwrD5x/fpNuV1Hr0ReqF1Hv0BBsF1Hv1eGv5Nbr1uWsFFLp0BJskFLt1RVuklbu0eWoFtbp1ZZpElTu1JJvEGL7/+lm2vaxyV13GhpzynfUJ6zJLd9TFr8ss2VGXtD6reHtN1qb8ku01aZvyi7ZVJ63LArE3ZAPZmRtzGb5///7n7/+/f///A6P/QPQHRP778w/Exg3+/fvH8PrBk7dPX3948ebTq9df3n/4/Pbd53fvP799D2K8ff/j4+fvnz4DyR+foIzvn6AIKMLw6dWXr+9//P3xC2jU/39AO/+BGTD0F+wqoCAU/YWRIAbD58/ff//6C3LzfywIPwAA1Kl1SfeHCK8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"app.html\"\n        title=\"app.html\"\n        src=\"/static/db23be24b31e5d031f00b39a96cbd7de/91043/app.png\"\n        srcset=\"/static/db23be24b31e5d031f00b39a96cbd7de/0ca2e/app.png 180w,\n/static/db23be24b31e5d031f00b39a96cbd7de/34b33/app.png 360w,\n/static/db23be24b31e5d031f00b39a96cbd7de/91043/app.png 720w,\n/static/db23be24b31e5d031f00b39a96cbd7de/9d22c/app.png 1080w,\n/static/db23be24b31e5d031f00b39a96cbd7de/5a2b3/app.png 1440w,\n/static/db23be24b31e5d031f00b39a96cbd7de/714c9/app.png 1825w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Going through the kernel patch gives us the following snippet of code which contains the information for translating our USB leftover capture data into the corresponding gamepad buttons.</p>\n<pre><code class=\"language-c\">...\n> +               /* Parse digital buttons */\n> +               ctlr->but_y             = 0x01 &#x26;amp; data[3];\n> +               ctlr->but_x             = 0x02 &#x26;amp; data[3];\n> +               ctlr->but_b             = 0x04 &#x26;amp; data[3];\n> +               ctlr->but_a             = 0x08 &#x26;amp; data[3];\n> +               ctlr->but_sr_right_jc   = 0x10 &#x26;amp; data[3];\n> +               ctlr->but_sl_right_jc   = 0x20 &#x26;amp; data[3];\n> +               ctlr->but_r             = 0x40 &#x26;amp; data[3];\n> +               ctlr->but_zr            = 0x80 &#x26;amp; data[3];\n> +               ctlr->but_l             = 0x40 &#x26;amp; data[5];\n> +               ctlr->but_zl            = 0x80 &#x26;amp; data[5];\n> +               ctlr->but_minus         = 0x01 &#x26;amp; data[4];\n> +               ctlr->but_plus          = 0x02 &#x26;amp; data[4];\n> +               ctlr->but_rstick        = 0x04 &#x26;amp; data[4];\n> +               ctlr->but_lstick        = 0x08 &#x26;amp; data[4];\n> +               ctlr->but_home          = 0x10 &#x26;amp; data[4];\n> +               ctlr->but_capture       = 0x20 &#x26;amp; data[4];\n> +               ctlr->but_down          = 0x01 &#x26;amp; data[5];\n> +               ctlr->but_up            = 0x02 &#x26;amp; data[5];\n> +               ctlr->but_right         = 0x04 &#x26;amp; data[5];\n> +               ctlr->but_left          = 0x08 &#x26;amp; data[5];\n> +               ctlr->but_sr_left_jc    = 0x10 &#x26;amp; data[5];\n> +               ctlr->but_sl_left_jc    = 0x20 &#x26;amp; data[5];\n...\n</code></pre>\n<p>We can dump the USB leftover capture data using Wireshark and solve the challenge by calling <code>handleButtons</code> with the correct order of commands.</p>\n<pre><code class=\"language-sh\">$ tshark -r PlayCAP.pcapng -Y \"usb.transfer_type==0x01 &#x26;&#x26; frame.len==91 &#x26;&#x26; usb.endpoint_address.direction==IN\" -e usb.capdata -Tfields > usbcap.txt\n</code></pre>\n<p>The solution script is present in <a href=\"/c89d2acf8d925fe4f7b29cc259272ef9/solve.py\">solve.py</a>.</p>\n<pre><code class=\"language-sh\">$ python3 solve.py\nhandleButtons(\"reset\", true)\nhandleButtons(\"reset\", true)\nhandleButtons(\"reset\", true)\nhandleButtons(\"reset\", true)\nhandleButtons(\"right\", true)\nhandleButtons(\"right\", true)\nhandleButtons(\"right\", true)\nhandleButtons(\"select\", true)\nhandleButtons(\"down\", true)\nhandleButtons(\"down\", true)\n...\n</code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 720px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/708904c58f61e3e123ab0a05308b2400/c94d1/solved.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.70886075949367%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAAsSAAALEgHS3X78AAADgUlEQVQ4y52RbUxTVxjHz+xkCPKmHeWlvDjEDTYIU6ewF4j7xDRDs+3DorxkH6bVDJcN10EpLa3Q26atCESdbpkvgQVw07JksakviSZz+7BsKnNfFosJpb1t722lHfeee869raeFGeMn65ObPOece373//8/F8Tj8VgstjjtCFH9zNFBPDl+47ezRlfPd9dNJpfe8ecPJ349ZnNpzJe6Tt88ef6PM5Sr9/gVjeVyv3PmIiCwGI89aG31vFv9z57Xpfom67mvgTa98UgZ6F758finReYNcn12mnZV9VDD+2d3P9cjq7OWgJ6c/Re6EnA8Ft8+uqNGI28ZWFelr+r8sQvocistpUCzumNyf4G19g2r8mUqv3q4addYe1pfZtPRihW6/IPT6mV4y6nmdGP2q/biHPP6fRe+BH05m+zloG9164Sq0FbbYC+pMMmrhxt3jrWt0K56Z+gloHvxM8cyHKv/pjlDl73FXrrGVKn6KQHX29cBbQJWWGu22pWVlLwqCcu0GW8deQI++Z5Ml6UYyM+jluENlhLQm9k2oSqy1cqNa7MMuTUjTS1J5TpbGYE7H4ObZX1ZhYOKvP+VK8wlQJPZPqEqsNZUmBRrDXmvDTfuGmsDmvRKs5JkfqQcf/PUjhf0uWVUsdz8yoGLh4BuTcPQevKJjskDxba6cqpQMSCvHd32wXgH0GYqKeXz+oKD091g6T9vHnk7TQ2K+jOydPmfTKjAIVBuzAFfgI/OtZcOlpMt6AJV1o0t338IPgey7pVAnbZ3qnNZ+djvpw9fMY5etxiu2R1//9LtMpquUWpn/9Qth+XGSI/L8JVTP3rz27G/ptROneGqqffy4M93nUn4WQsQz8S3KIm8IECEBCxIMRGJCGGERIwxwiIWJdIEcoessZR8hZEkiWBuzuOjvV6//18f5w7wdICZ93gDAYam/T4fzbIh7zzZBsnj9fqCQcabuBuc83gYNgTm5+igJ8z6F8IRbvE/gY/ypKAABUEgHSEEIUwcCIgnq8Qh6QJMFuBDUvAuCt8XZuloJMBjll8a4VNl5ljRfxsy9+A9X2QhwCGWSw0OzEDGDeeDUd7PYQ6lMO2E8gxkZ+F9OhKlOfwgRdv0bci6k7b9HGJStE3fgSH30sBSz0xsk4HN+iJR/yIOw9RhN5wlmQMcDqeSGfPSIiPCBTHCIYHDEoefftoPAdRa+Y6vsBvKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"solution\"\n        title=\"solution\"\n        src=\"/static/708904c58f61e3e123ab0a05308b2400/91043/solved.png\"\n        srcset=\"/static/708904c58f61e3e123ab0a05308b2400/0ca2e/solved.png 180w,\n/static/708904c58f61e3e123ab0a05308b2400/34b33/solved.png 360w,\n/static/708904c58f61e3e123ab0a05308b2400/91043/solved.png 720w,\n/static/708904c58f61e3e123ab0a05308b2400/c94d1/solved.png 790w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Flag: <code>DrgnS{LetsPlayAGamepad}</code></p>","relativePath":"writeups/teaser-dragon-ctf-2019/misc/PlayCAP/jaiverma"}}}