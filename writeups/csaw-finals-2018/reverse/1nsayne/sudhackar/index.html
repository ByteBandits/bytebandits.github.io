<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.b70e20b3353d36c40e1f.css">.search-module--search-bar--6m8v4{max-width:300px}.search-module--search-bar--6m8v4>input{background:hsla(0,0%,100%,.72);padding:10px;border-radius:12px;border:0}.search-module--search-bar--6m8v4>ul{position:absolute;max-width:300px;max-height:640px;overflow:auto;background:#f6f6f6;margin:0}.search-module--search-bar--6m8v4>ul li{color:#000;width:100%;display:inline-block;margin:0;padding:12px 16px;line-height:24px;border:2px solid rgba(0,102,51,.2)}.search-module--search-bar--6m8v4>ul li:hover{background:#fff}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,sans-serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,sans-serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;margin:0;padding:0}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}footer{padding:96px 0;background:#0f0f0f;bottom:0;text-align:center;position:relative}footer,footer a{color:#999}footer a:focus,footer a:hover{color:#fff}footer .footer-module--social--QNE_v{margin:18px 0 30px;padding:0;font-size:30px}footer .footer-module--social--QNE_v li{display:inline-block;font-size:30px;padding:0;margin:0 0 0 42px;color:#f06000}footer .footer-module--social--QNE_v li:first-child{margin-left:0}@media only screen and (max-width:480px){footer .footer-module--social--QNE_v{font-size:20px}footer .footer-module--social--QNE_v li{margin-left:14px}}footer .footer-module--copyright--1-FxK{margin:0;padding:0}footer .footer-module--copyright--1-FxK li{display:inline-block;margin:0;padding:0;line-height:24px}.footer-module--ie--21UzZ footer .footer-module--copyright--1-FxK li{display:inline}footer .footer-module--copyright--1-FxK li:before{content:"\2022";padding-left:10px;padding-right:10px;color:#095153}footer .footer-module--copyright--1-FxK li:first-child:before{display:none}.footer-module--gotop--35bFg{position:absolute;top:-24px;left:50%;margin-left:-30px}.footer-module--gotop--35bFg a{text-decoration:none;border:0;display:block;width:48px;height:48px;background-color:#0f9095;transition:all .2s ease-in-out;color:#fff;font-size:21px;line-height:50px;border-radius:100%;box-shadow:0 0 12px rgba(0,0,0,.2)}.footer-module--gotop--35bFg a:hover{background-color:#6f9}@media only screen and (max-width:767px){.footer-module--gotop--35bFg{margin-left:-22px}.footer-module--gotop--35bFg a{width:54px;height:54px;font-size:18px;line-height:54px}}.index-module--textBanner--YjZ-8{background:rgba(0,0,0,.6);border-radius:8px;border:1px solid rgba(0,96,0,.72)}.index-module--textBanner--YjZ-8 a{color:inherit}.team-module--social--1kmzU a{font-size:1.4rem;color:#6e6e6e}.writeups-module--card--2nKXd>p{margin:0;font-size:.75em;color:#efefef}.writeups-module--card--2nKXd>p:first-child{font-weight:700;color:#fff;font-size:1em}</style><meta name="generator" content="Gatsby 2.1.17"/><title data-react-helmet="true"></title><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><link as="script" rel="preload" href="/webpack-runtime-b43f22e3f99665bd1fdd.js"/><link as="script" rel="preload" href="/app-1f2a7d69cb8eac8e2c0d.js"/><link as="script" rel="preload" href="/styles-6be565da593ea1e2c74c.js"/><link as="script" rel="preload" href="/1-5e9782c24f0152571c1b.js"/><link as="script" rel="preload" href="/2-eb3785f67d00c46777d7.js"/><link as="script" rel="preload" href="/component---src-templates-writeup-js-26c8982da4d84d9aee72.js"/><link as="fetch" rel="preload" href="/static/d/434/path---writeups-csaw-finals-2018-reverse-1-nsayne-sudhackar-9-f-0-863-M5NDvOs5cXXsnKhyLDeuS6x2Xfs.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group">  <div class="headroom-wrapper"><div style="position:relative;top:0;left:0;right:0;z-index:100;-webkit-transform:translate3D(0, 0, 0);-ms-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0);background:#000000;margin-bottom:1.45rem;height:107px;border-bottom:2px solid green" class="headroom headroom--unfixed"><div size="500" class="sc-iwsKbI jXtcuH"><div style="margin:0 auto;max-width:960px" class="sc-bdVaJa sc-bwzfXH jruoDg"><a href="/"><img height="96" alt="ByteBandits Logo" src="https://avatars3.githubusercontent.com/u/14941705?s=200&amp;v=4" style="display:inline"/></a><div class="sc-bdVaJa LbkC"></div><div color="backgroundLight" font-size="2,3" class="sc-bdVaJa dPPJdK"><a style="color:white;max-width:960px;cursor:pointer" class="sc-htoDjs cndfJV" href="/">Home</a></div><div color="backgroundLight" font-size="2,3" class="sc-bdVaJa dPPJdK"><a style="color:white;max-width:960px;cursor:pointer" class="sc-htoDjs cndfJV" href="/team">Team</a></div><div color="backgroundLight" font-size="2,3" class="sc-bdVaJa dPPJdK"><a style="color:white;max-width:960px;cursor:pointer" class="sc-htoDjs cndfJV" href="/writeups">Writeups</a></div><div color="backgroundLight" font-size="2,3" class="sc-bdVaJa dPPJdK"><div size="640" class="sc-iwsKbI fhOwHm"><div class="search-module--search-bar--6m8v4"><input type="text" value="" placeholder="Search writeups.."/><ul></ul></div></div></div></div></div><div size="500" class="sc-dnqmqq fOxYoa"><div class="sc-bdVaJa sc-bwzfXH ecOMxn"><div width="1" class="sc-bdVaJa sc-bwzfXH hZVZsp"><a href="/"><img height="96" alt="ByteBandits Logo" src="https://avatars3.githubusercontent.com/u/14941705?s=200&amp;v=4" style="display:inline"/></a><div class="sc-bdVaJa LbkC"></div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="30" color="white" style="color:white" height="30" width="30"><path d="M2 15.5v2h20v-2H2zm0-5v2h20v-2H2zm0-5v2h20v-2H2z"></path></svg></div></div></div></div></div><div style="margin:0 auto;max-width:960px;padding-top:24px"><main><div style="color:grey;margin-top:24px;text-align:right"><a href="https://github.com/ByteBandits/writeups/tree/master/csaw-finals-2018/reverse/1nsayne/sudhackar">View this writeup on GitHub</a></div><div style="margin-bottom:64px"><p><a href="ctf=csaw-finals-2018"></a>
<a href="type=reverse"></a>
<a href="tags=fibonacci"></a>
<a href="tools=radare2,r2"></a></p>
<h1>1nsayne (rev-250)</h1>
<p>We are given a  <a href="/1nsayne-105026389d45540740da165f759f478c.">binary</a>.</p>
<pre><code class="language-sh">$ file 1nsayne 
1nsayne: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, stripped
</code></pre>
<p>On running it waits for some input. Input is later compared with so0per_cool.</p>
<pre><code class="language-sh">$ ltrace -fbi ./1nsayne
[pid 25528] [0x400890] setvbuf(0x7f3ac22df760, 0, 2, 0)                                                               = 0
[pid 25528] [0x4038b5] fgets(lol
"lol\n", 99, 0x7f3ac22dea00)                                                             = 0x6042a0
[pid 25528] [0x4038c7] strchr("lol\n", '\n')                                                                          = "\n"
[pid 25528] [0x4036cb] strcmp("lol", "so0per_cool")                                                                   = -7
[pid 25528] [0xffffffffffffffff] +++ exited (status 0) +++
</code></pre>
<p>Simply passing so0per_cool as input starts printing some message.</p>
<pre><code class="language-sh">$ ltrace -fbi ./1nsayne
[pid 26640] [0x400890] setvbuf(0x7f70174cb760, 0, 2, 0)                                                               = 0
[pid 26640] [0x4038b5] fgets(so0per_cool
"so0per_cool\n", 99, 0x7f70174caa00)                                                     = 0x6042a0
[pid 26640] [0x4038c7] strchr("so0per_cool\n", '\n')                                                                  = "\n"
[pid 26640] [0x4036cb] strcmp("so0per_cool", "so0per_cool")                                                           = 0
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x403119] strlen("so0per_cool")                                                                          = 11
[pid 26640] [0x402b75] pow(1, 0, 0x403b00, 2)                                                                         = 0
[pid 26640] [0x402c16] sleep(5)                                                                                       = 0
[pid 26640] [0x402cd5] printf("%c", 'h'h)                                                                              = 1
[pid 26640] [0x402c16] sleep(5)                                                                                       = 0
[pid 26640] [0x402cd5] printf("%c", 'i'i)                                                                              = 1
</code></pre>
<p>Its printing some message byte-by-byte with some <code>sleep</code> in between. This should be easy to bypass using <code>desleep</code> from <a href="https://github.com/zardus/preeny">preeny</a>.</p>
<p>Even then it took more than a minute to print this much</p>
<pre><code class="language-sh">$ LD_PRELOAD=~/tools/preeny/build_x64/lib/libdesleep.so ./1nsayne 
so0per_cool
hi! flag is
</code></pre>
<p>We have not reversed the file yet. Lets dig deeper using radare2.
Directly opening from entry0 and main I see that this binary has been obfuscated to some level using frequent <code>jmp</code>s and some dummy code, empty loops, random variables etc.
So to start simple I'll start by seeking to where the character was getting <code>printf</code>d from the ltrace logs 0x402cd5</p>
<pre><code class="language-sh">$ r2 -AAAA 1nsayne
[x] Analyze all flags starting with sym. and entry0 (aa)
[x] Analyze function calls (aac)
[x] Analyze len bytes of instructions for references (aar)
[x] Constructing a function name for fcn.* and sym.func.* functions (aan)
[x] Enable constraint types analysis for variables
 -- Don't wait for Travis
[0x00400780]> s 0x402cd5
[0x00402cd5]> pd-20
│           ; CODE XREFS from sub.pow_b20 (0x402c63, 0x402ec0)
│           0x00402c82      48bf7c3b4000.  movabs rdi, 0x403b7c        ; '|;@' ; "%c"
│           0x00402c8c      488b45e0       mov rax, qword [local_20h]
│           0x00402c90      31c9           xor ecx, ecx
│           0x00402c92      89ca           mov edx, ecx
│           0x00402c94      48f775d0       div qword [local_30h]
│           0x00402c98      488b75d8       mov rsi, qword [local_28h]
│           0x00402c9c      89f1           mov ecx, esi
│           0x00402c9e      4863f1         movsxd rsi, ecx
│           0x00402ca1      488914f50843.  mov qword [rsi*8 + 0x604308], rdx ; [0x604308:8]=0
│           0x00402ca9      488b55d8       mov rdx, qword [local_28h]
│           0x00402cad      89d1           mov ecx, edx
│           0x00402caf      4863d1         movsxd rdx, ecx
│           0x00402cb2      488b14d58840.  mov rdx, qword [rdx*8 + 0x604088] ; [0x604088:8]=105
│           0x00402cba      488b75d8       mov rsi, qword [local_28h]
│           0x00402cbe      89f1           mov ecx, esi
│           0x00402cc0      4863f1         movsxd rsi, ecx
│           0x00402cc3      483314f50843.  xor rdx, qword [rsi*8 + 0x604308]
│           0x00402ccb      4889d6         mov rsi, rdx
│           0x00402cce      b000           mov al, 0
│           0x00402cd0      e81bdaffff     call sym.imp.printf         ; int printf(const char *format)
</code></pre>
<p>This block calculates <code>local_20h</code> % <code>local_30h</code>nd stores it to index <code>local_28h</code> an array of <code>qword</code> at 0x604308.
Later value is read and xored with <code>qword</code> at index <code>local_28h</code> of array at 0x604088 and is printed as a char.</p>
<p>Rename the variables to make sense</p>
<pre><code class="language-sh">[0x00402cd5]> afvn mod local_30h
[0x00402cd5]> afvn idx local_28h
[0x00402cd5]> afvn some_value local_20h
</code></pre>
<p>As for the arrays 0x604088 has been initialized with some values and 0x604308 is all 0's.</p>
<pre><code class="language-sh">[0x00604308]> s 0x604088
[0x00604088]> pxq 16
0x00604088  0x0000000000000069  0x000000000000006b   i.......k.......
[0x00604088]> s 0x604308
[0x00604308]> pxq 16
0x00604308  0x0000000000000000  0x0000000000000000   ................
[0x00604308]> 
</code></pre>
<p>The logic to dump chars is now</p>
<pre><code class="language-python">for idx in xrange(unknown_1):
    putchar(arr_0x604088[idx] ^ (some_value % mod))
</code></pre>
<p>Seeking to the start of the current function we see that <code>mod</code> is set by some floating point calculations.</p>
<pre><code class="language-sh">[0x00402cd5]> sf.
[0x00402b20]> pd30
┌ (fcn) sub.pow_b20 1484
│   sub.pow_b20 ();
....
│           ; CALL XREF from sub.strlen_f0 (0x403206)
│           0x00402b20      55             push rbp
│           0x00402b21      4889e5         mov rbp, rsp
│           0x00402b24      4881ec200100.  sub rsp, 0x120
│           0x00402b2b      48c745f80200.  mov qword [local_8h], 2
│           0x00402b33      31c0           xor eax, eax
│           0x00402b35      89c7           mov edi, eax
│           0x00402b37      e824f0ffff     call fcn.00401b60
│           0x00402b3c      488945f0       mov qword [local_10h], rax
│           0x00402b40      b901000000     mov ecx, 1
│           0x00402b45      89cf           mov edi, ecx
│           0x00402b47      e814f0ffff     call fcn.00401b60
│           0x00402b4c      488945e8       mov qword [local_18h], rax
│           0x00402b50      48c745e00000.  mov qword [some_value], 0
│           0x00402b58      48c745d80000.  mov qword [idx], 0
│           0x00402b60      f20f1005f00f.  movsd xmm0, qword [0x00403b58] ; [0x403b58:8]=0x4024000000000000
│           0x00402b68      f20f100df00f.  movsd xmm1, qword [0x00403b60] ; [0x403b60:8]=0x4033000000000000
│           0x00402b70      e8dbdbffff     call sym.imp.pow
│           0x00402b75      f20f100deb0f.  movsd xmm1, qword [0x00403b68] ; [0x403b68:8]=0x43e0000000000000
│           0x00402b7d      0f28d0         movaps xmm2, xmm0
│           0x00402b80      f20f5cd1       subsd xmm2, xmm1
│           0x00402b84      f2480f2cc2     cvttsd2si rax, xmm2
│           0x00402b89      48bf00000000.  movabs rdi, 0x8000000000000000
│           0x00402b93      4831f8         xor rax, rdi
│           0x00402b96      f2480f2cf8     cvttsd2si rdi, xmm0
│           0x00402b9b      660f2ec1       ucomisd xmm0, xmm1
│           0x00402b9f      480f42c7       cmovb rax, rdi
│           0x00402ba3      488945d0       mov qword [mod], rax
│       ┌─&#x3C; 0x00402ba7      e963010000     jmp 0x402d0f
│       │   ; CODE XREFS from sub.pow_b20 (0x402d62, 0x402dc7, 0x403055, 0x4030bd)
│       │   0x00402bac      488b45d8       mov rax, qword [idx]
│       │   0x00402bb0      bf451c6b63     mov edi, 0x636b1c45
</code></pre>
<p>So <code>mod</code> should be a static value for this case.
Looking around in Visual mode we can find that <code>some_value</code> is set directly from calling <code>fcn.00401b60</code> with <code>local_8h</code> as an argument</p>
<pre><code class="language-sh">[0x00402b20]> s 0x402c0c
[0x00402c0c]> pd 20
│           ; CODE XREFS from sub.pow_b20 (0x402bed, 0x402e32, 0x402e73)
│           0x00402c0c      bf05000000     mov edi, 5
│           0x00402c11      e81adbffff     call sym.imp.sleep          ; int sleep(int s)
│           0x00402c16      488b7df8       mov rdi, qword [local_8h]
│           0x00402c1a      8945a4         mov dword [local_5ch], eax
│           0x00402c1d      e83eefffff     call fcn.00401b60
│           0x00402c22      488945e0       mov qword [some_value], rax
│           0x00402c26      488b7df8       mov rdi, qword [local_8h]
│           0x00402c2a      e871dcffff     call sub.sqrt_8a0
│           0x00402c2f      88c1           mov cl, al
│           0x00402c31      bf451c6b63     mov edi, 0x636b1c45
│           0x00402c36      8845a3         mov byte [local_5dh], al
│           0x00402c39      884da2         mov byte [local_5eh], cl
│           0x00402c3c      e83f0e0000     call fcn.00403a80
│           0x00402c41      8a4da3         mov cl, byte [local_5dh]
│           0x00402c44      0fb6f9         movzx edi, cl
│           0x00402c47      84c9           test cl, cl
│           0x00402c49      89459c         mov dword [local_64h], eax
│           0x00402c4c      897d98         mov dword [local_68h], edi
</code></pre>
<p>After <code>some_value</code> is called, <code>local_5dh</code> is set by calling <code>sub.sqrt_8a0</code> and depending on its value the character is printed
so now the eventual code is </p>
<pre><code class="language-python">idx = 0

for local_8h in xrange(unknown_1):
    some_value = fcn.00401b60(local_8h)
    local_5dh = sub.sqrt_8a0(local_8h)
    if local_5dh:
        printf(arr_0x604088[idx] ^ (some_value % mod))
        idx+=1
</code></pre>
<p><code>mod</code> and <code>arr_0x604088</code> are constants, only variables are the result of functions -> <code>some_value</code> and <code>local_5dh</code>.</p>
<p>Opening them in visual mode show similar obfuscation.
graph for <code>fcn.00401b60</code></p>
<p><a
    class="gatsby-resp-image-link"
    href="/static/95fcb6fa942237a456c431c51297b68d/e30c5/graph.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 720px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 150.7777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAD/UlEQVRIx62V6XLbNhSF9fBOJi/gyLXT9gnazjSTN+k2XdLEiiRuWEkCJEji9EAkY9l1F6f9geEGfHc793KjAfybpWKEjBNa3n8j3+DF/gWu+xtch2tchc/wRf8lsthi8ynAr8S3uNhdYNtf4Wq4wsvhJW7Cq08Hfi1e49mHC1ytwPASr/4XYJiB22FL4Of/AShf4/nhGbbdlmFvcdld4qa7wfGpQEVgk4qi3xD4HJftJbaBwP7yaTlUiAswnp7fdjm+q3/FD/Y3/DLu8X18jx+nHQQNPslDE4EKA0To0BgP202w7QDVdfAT0PL75p8gd+HO68gsZqNDUXeoCC6kgLUG3TSiCePfABNgvS7gHB4HAg+NRCkNrHfQdQspDA6Dw94PjwBXr86gavEyix7F1CPzLYxzyHsLaTRU3UAy7Mw/zOEa2rln6eoJEgJVCi84vPMNve3wLkrINhlxqOKI3J/n8Cy084qqPtCDGsK1EASZ2EMgnL5lU4vCdgTVqKYHQPWwEMOAqqlRNh56mr1OXhXo6c0wA+EgDMNtW57j8196mGCmRUmPSgLMYjBjUQp6mAqTuuYQLDJjUDECGQZ6GB8H5j2tGosyEEDdaW4W9EKwko4gOXqUVtNojWYc4LgMnZDTAjzPnY6zJ5qbsq7H+9qfQs+rAm3TgPqFbAJyoaD53I1AP1HgSzE393oVMzjJI11L5mynMmjLYtDrQ7lH1TXIHDtmnNNwcPFja6YoN3+qbJyTnfK26z1u24oCZiGYS5k6wyjkhl0yzPtTZefzM+NeyJKul5JdoCXCMEIxhwdqzPLbMbp5HzVZupHABKLYfTxdV8adh4RVtYVQEo3rMDHBDbuipObMUuG0J2cPH+vwADh7eB84jihVqlyDnu/6kQM1tRk9lP2A49AiDy0qZ1Fp9zHkOw8fCVnEJJll/vE5TZNMllCUR8cUdBPlQdkk42uLZt3aug9CThUq2BVpLNkFmA5WSbhSw/U9PGFm7fVk0NOg9XN0AxYdpn8FJ0VpFXal5hBooHn41G4pbB66zRrshab++C0Vi98k9+TCItcG5VL5U+tJKryQlnKQ2Gu2lfQQlhs7i50tUPH+aGu8zfmdgHLkQEjFozYF5VSchoZj/il+Cv4UsqA1FeYJUnHOlVKdPPmdc+WDT4ZKQirkbLmcesxqDaHt6adllhoIdpUiJxUlrothxGMtozR1pAbjTzjE41DHsjZ810YzhrgLkntUFMpGG0IkLKozxiZZWJdmcpPbxvWwzuNnqq/g/yNVueLcM2y3W8d3jEBQLu3Z2XUlD31atHS6FvyBldr4Qkp/2xV8tl7Uxu+18Lu+9YW3npPI537yaj3Hdbrn+gPfn/5GG06diQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    ></span>
    <img
        class="gatsby-resp-image-image"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;"
        alt="fcn.00401b60"
        title=""
        src="/static/95fcb6fa942237a456c431c51297b68d/5b758/graph.png"
        srcset="/static/95fcb6fa942237a456c431c51297b68d/e6885/graph.png 180w,
/static/95fcb6fa942237a456c431c51297b68d/e17e9/graph.png 360w,
/static/95fcb6fa942237a456c431c51297b68d/5b758/graph.png 720w,
/static/95fcb6fa942237a456c431c51297b68d/e30c5/graph.png 900w"
        sizes="(max-width: 720px) 100vw, 720px"
      />
  </span>
  </a></p>
<p>Both functions take one argument and don't change any global variable. They call themselves recrsively or other functions with time consuming code. They have unnecessary loops and jumps that cause the program to run slow. We have seen similar challs in CTFs where simple constructs are written to waste time/CPU resources. We need to simplify these functions.</p>
<p>I tried to dynamically analyze the functions using this code. </p>
<pre><code class="language-python">import r2pipe

r2 = r2pipe.open("./1nsayne")
# reopen in debug mode
r2.cmd("doo")
r2.cmd("aaaa")

#set bp on entry
r2.cmd("db `ie~:1~[1]`")

#           0x00402c1d      e83eefffff     call fcn.00401b60
f1 = 0x00402c1d
r2.cmd("db 0x%x" % f1)
r2.cmd("db 0x%x" % (f1+5))

#           0x00402c2a      e871dcffff     call sub.sqrt_8a0
f2 = 0x00402c2a
r2.cmd("db 0x%x" % f2)
r2.cmd("db 0x%x" % (f2+5))

print r2.cmd("dbi")

r2.cmd("dc")

f1_m = []
f2_m = []

for i in xrange(32):
    r2.cmd("dr rip=0x%x" % f1)
    r2.cmd("dr rdi=0x%x" % i)
    r2.cmd("dc")
    f1_m.append(int(r2.cmd("dr rax"),16))

for i in xrange(32):
    r2.cmd("dr rip=0x%x" % f2)
    r2.cmd("dr rdi=0x%x" % i)
    r2.cmd("dc")
    f2_m.append(int(r2.cmd("dr rax"),16))

r2.quit()

print f1_m
print f2_m
</code></pre>
<p>What I'm doing here is I'm calling <code>fcn.00401b60</code> and <code>sub.sqrt_8a0</code> with argument in [0..32] so that I can predict or analyze the output which was</p>
<pre><code class="language-python">[0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597, 2584, 4181, 6765, 10946, 17711, 28657, 46368, 75025, 121393, 196418, 317811, 514229, 832040, 1346269]
[0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1]
</code></pre>
<p> First output is fibonacci numbers, so  <code>fcn.00401b60(i)</code> returns <code>fibonacci(i)</code>. Thats why it was taking a lot of time for later bytes of the flag. This computation is recursive with no memoization.</p>
<p> Second output doesn't make sense as now, but <code>sub.sqrt_8a0(i)</code> returns if <code>i</code> is prime or not.</p>
<p> Now we have all we need. We only have to dump <code>arr_0x604088</code>.</p>
<pre><code class="language-sh">[0x00604088]> pxQ 62*8~[1]
0x0000000000000069
0x000000000000006b
0x0000000000000024
0x000000000000002d
</code></pre>
<p>Final code to dump the flag </p>
<pre><code class="language-python">from Crypto.Util.number import isPrime
mod = 0x8ac7230489e80000

def fib(n, _cache={}):
    '''efficiently memoized recursive function, returns a Fibonacci number'''
    if n in _cache:
        return _cache[n]
    elif n > 1:
        return _cache.setdefault(n, fib(n-1) + fib(n-2))
    return n

'''
[0x00604088]> pxq 62*8
'''
flag = ''

arr_0x604088 = [0x0000000000000069, 0x000000000000006b, 0x0000000000000024, 0x000000000000002d, 0x000000000000003f, 0x0000000000000085, 0x000000000000065c, 0x0000000000001032, 0x0000000000006fd1, 0x000000000007d8dc, 0x0000000000148aae, 0x0000000001709e43, 0x0000000009de8d4d, 0x0000000019d699c3, 0x00000000b119248d, 0x0000000c69e60a04, 0x000000dec113965e, 0x000002472d96a972, 0x000028e0b4bf2bb9, 0x0001182e2989cebd, 0x0002dd8587da6e47, 0x00336a82d89c9330, 0x016069317e428cf6, 0x18b3c1d91e77de9d, 0x3240e2d181223220, 0x2baf6373dbe838b6, 0x073950ec18c5313e, 0x41838009bc58e07c, 0x4fc6cdc83cbb455a, 0x19568517131788a2, 0x030f7bd5f7e4a029, 0x67f7e718178ec0e7, 0x014b63ebbe1f7469, 0x6fd5280bc8cbb8ba, 0x493f53f1269e0b1c, 0x3f94756512a1ef8c, 0x374f52aaa0d0553d, 0x6354887f00940f76, 0x7c63c3b79148c8f9, 0x1a72a23c580389e4, 0x4a1d5e7d8b26e807, 0x68824ddf2c14b0be, 0x0988b22957af8bde, 0x005a365e21fdb4b9, 0x70febf7992c701ec, 0x45e80772963b72e3, 0x5b656a15e45ad6b4, 0x4d858b58f9cec52f, 0x4b85e107e3108430, 0x24c6b1482aff1e90, 0x43a3e729aec76a88, 0x1fc747c217b50012, 0x4af69f78486233fe, 0x1a5964ce9b71f58d, 0x6cb1150f7bf8ab6f, 0x7dfd4f0d1b421262, 0x4d736c985a149eca, 0x762bc1ac0419dd9e, 0x39deb71e84b24129, 0x80072969eea6cc22, 0x5ad24c5e14feb5a9, 0x454e2d665f785a38]
idx = 0
i = 0

while True:
    if idx == 62:
        break
    if isPrime(i):
        flag += chr((arr_0x604088[idx] ^ (fib(i) %  mod)) % 0xff)
        idx += 1
    i += 1

print flag
</code></pre>
<p>prints</p>
<blockquote>
<p>hi! flag is: flag{LlvM_Passes_4nD_9atCh1ng_8inaryies_4r3_c0ol}</p>
</blockquote></div></main></div><footer><ul class="footer-module--social--QNE_v"><li><a href="https://twitter.com/BanditsByte"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></li><li><a href="https://github.com/ByteBandits/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li></ul><ul class="footer-module--copyright--1-FxK"><li>© <!-- -->2019<!-- -->, ByteBandits</li></ul><div class="footer-module--gotop--35bFg"><a title="Back to Top" href="#top"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em"><path d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"></path></svg></a></div></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-136974496-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-writeup-js","jsonName":"writeups-csaw-finals-2018-reverse-1-nsayne-sudhackar-9f0","path":"/writeups/csaw-finals-2018/reverse/1nsayne/sudhackar"};window.dataPath="434/path---writeups-csaw-finals-2018-reverse-1-nsayne-sudhackar-9-f-0-863-M5NDvOs5cXXsnKhyLDeuS6x2Xfs";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-1f2a7d69cb8eac8e2c0d.js"],"component---src-templates-writeup-js":["/component---src-templates-writeup-js-26c8982da4d84d9aee72.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a488c3b04d06213767db.js"],"component---src-pages-index-js":["/component---src-pages-index-js-755e5a8db884d72c999a.js"],"component---src-pages-team-js":["/component---src-pages-team-js-aaea7332b2b2b68776ce.js"],"component---src-pages-writeups-js":["/component---src-pages-writeups-js-2656e89c850bf0d3eaad.js"],"pages-manifest":["/pages-manifest-5d3dc236307686aa7f90.js"]};/*]]>*/</script><script src="/component---src-templates-writeup-js-26c8982da4d84d9aee72.js" async=""></script><script src="/2-eb3785f67d00c46777d7.js" async=""></script><script src="/1-5e9782c24f0152571c1b.js" async=""></script><script src="/styles-6be565da593ea1e2c74c.js" async=""></script><script src="/app-1f2a7d69cb8eac8e2c0d.js" async=""></script><script src="/webpack-runtime-b43f22e3f99665bd1fdd.js" async=""></script></body></html>